<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ارسال کد تایید</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>
<body>
    <h1>بررسی کد تأیید</h1>

    <!-- فرم برای وارد کردن نام، ایمیل و پسورد -->
    <input type="text" id="userName" placeholder="نام خود را وارد کنید" required>
    <input type="email" id="emailTo" placeholder="ایمیل را وارد کنید" required>
    <input type="password" id="userPass" placeholder="پسورد را وارد کنید" required>
    <button id="sendCode">ارسال کد</button>

    <!-- تایمر -->
    <p id="timer"></p>

    <!-- فرم برای وارد کردن کد تایید -->
    <input type="text" id="userInput" placeholder="کد را وارد کنید" disabled>
    <button id="checkCode" disabled>بررسی کد</button>

    <!-- نتیجه بررسی کد -->
    <p id="result"></p>

    <script>
        let generatedCode = "";
        let timerInterval;
        let timeLeft = 300; // 5 دقیقه = 300 ثانیه

        // تنظیمات EmailJS
        emailjs.init("YOUR_USER_ID"); // از حساب EmailJS خود user_id را جایگزین کنید

        // ارسال کد به ایمیل
        $("#sendCode").click(function () {
            const userName = $("#userName").val();
            const email_to = $("#emailTo").val(); // دریافت ایمیل کاربر
            const userPass = $("#userPass").val();

            // اعتبارسنجی فرم
            if (!userName || !email_to || !userPass) {
                alert("لطفاً تمام فیلدها را پر کنید.");
                return;
            }

            // ارسال ایمیل و کد تایید
            generatedCode = Math.floor(1000 + Math.random() * 9000); // تولید کد ۴ رقمی
            const message = `کد تایید شما: ${generatedCode}`;
            const templateParams = {
                to_email: email_to,
                message: message
            };

            emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", templateParams)
                .then(function(response) {
                    console.log("ایمیل ارسال شد:", response);

                    // فعال کردن ورودی برای وارد کردن کد و دکمه بررسی
                    $("#userInput").prop('disabled', false);
                    $("#checkCode").prop('disabled', false);

                    // مخفی کردن دکمه ارسال کد
                    $("#sendCode").prop('disabled', true);

                    // شروع تایمر برای انقضا کد
                    startTimer();

                }, function(error) {
                    console.log("خطا در ارسال ایمیل:", error);
                });
        });

        // شروع تایمر
        function startTimer() {
            timerInterval = setInterval(function() {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    $("#timer").text("زمان انقضا کد تمام شده است.");
                    $("#checkCode").prop('disabled', true); // غیر فعال کردن دکمه بررسی
                    $("#userInput").prop('disabled', true); // غیر فعال کردن ورودی
                } else {
                    $("#timer").text(`زمان باقی‌مانده: ${timeLeft} ثانیه`);
                    timeLeft -= 1;
                }
            }, 1000);
        }

        // بررسی کد
        $("#checkCode").click(function () {
            const userInput = $("#userInput").val();

            if (userInput === generatedCode.toString()) {
                $("#result").text("کد تایید درست است!");
                $("#result").css("color", "green");

                // ارسال درخواست به PHP برای ذخیره اطلاعات در دیتابیس
                $.ajax({
                    url: "save_user.php", // مسیر فایل PHP برای ذخیره اطلاعات
                    method: "POST",
                    data: {
                        userName: $("#userName").val(),
                        email: $("#emailTo").val(),
                        userPass: $("#userPass").val(),
                        generatedCode: generatedCode
                    },
                    success: function(response) {
                        alert(response); // نمایش پیام از PHP
                    }
                });
            } else {
                $("#result").text("کد تایید اشتباه است.");
                $("#result").css("color", "red");
            }
        });
    </script>
</body>
</html>
